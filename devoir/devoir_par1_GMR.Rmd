---
title: "Devoir - partie 1"
output:
  html_document:
    df_print: paged
  html_notebook:
    highlight: tango
    theme: cerulean
---

On réalise une étude afin d'estimer la prévalence de la maladie $M$ en population générale adulte en Île-de-France (adultes de 20 à 90 ans).

Pour cela, on réalise le diagnostic dans un échantillon de 6348 sujets, composé de sujets issus de 5 cohortes :

- 2686 participants de la cohorte A ;
- 2934 participants de la cohorte B ;
- 112 participants de la cohorte C ;
- 119 participants de la cohorte D ;
- 497 participants de la cohorte E.

Les populations cibles de ces cohortes sont les suivantes :

- A : hommes et femmes de 20 à 80 ans ;
- B : hommes et femmes de 20 à 90 ans ;
- C : femmes de 70 à 90 ans ;
- D : hommes de 70 à 90 ans ;
- E : hommes et femmes de 25 à 70 ans.

Le tableau `devoir_sample` contient les données de cet échantillon. Les variables sont les suivantes :

- `id` : identifiant unique de chaque sujet ;
- `cohorte` : cohorte d'origine du sujet ;
- `age` : âge du sujet ;
- `sexe_m` : sexe masculin (`0` = femme, `1` = homme) ;
- `csp` : catégorie socio-professionnelle (8 catégories) ;
- `poids_sond` : poids de sondage (inverse des probabilités d'inclusion);
- `statut` : présence de la maladie (`0` = non, `1` = oui).

```{r, include = FALSE}
library(tidyverse)
library(knitr)
```

```{r, include = FALSE}
coco <- read_csv("devoir_sample.csv")
```


### Question 1

En faisant l'hypothèse que les poids de sondage décrivent directement le nombre de sujets représentés dans la population cible (on verra par la suite que cette hypothèse est discutable), estimer pour chacune des cohortes la prévalence de la maladie dans sa population-cible.

* Structure du tableau de données

```{r}
glimpse(coco)
```

```{r}
coco %>% 
  count(cohorte) %>% 
  kable()
```

* Données manquantes

```{r}
coco %>% 
  summarise(across(everything(), ~ sum(is.na(.x)))) %>% 
  kable()
```
Des données manquante (69) pour les poids de sondages. Ces patients sont considérés comme n'ayant pas été pris (poids = 0).

* Calcul de la prévalence

```{r}
coco$poids_sond[is.na(coco$poids_sond)] <- 0
coco %>% 
  select(cohorte, statut, poids_sond) %>% 
  group_by(cohorte) %>% 
  summarise(Effectif = round(sum(poids_sond), 2),
            Prévalence = sum(poids_sond * statut) / sum(poids_sond),
            .groups = "drop") %>% 
  mutate(icinf = Prévalence - qnorm(0.975) * sqrt(Prévalence * (1 - Prévalence) / Effectif),
         icsup = Prévalence + qnorm(0.975) * sqrt(Prévalence * (1 - Prévalence) / Effectif),
         IC = paste0("[", round(icinf, 2), ";", round(icsup, 2), "]"),
         Prévalence = round(Prévalence, 2)) %>% 
  select(-icinf, -icsup) %>% 
  kable(align = "lrrr")
```

Voilà donc dans le tableau ci-dessus les prévalences dans les pseudo-populations recréées à l'aide des poids. Pour l'intervalle de confiance, j'ai pris la formule :
$$p \pm z_{\alpha/2} \times \sqrt{\frac{p \times (1-p)}{n}}$$
avec p la prévalence estimée et n l'effectif de la pseudo-population. Mais je ne sais pas si la formule s'applique bien dans ce cas.


### Question 2

On souhaite à présent utiliser l'information issue de toutes les cohortes pour estimer la prévalence de la maladie dans toute la population des 20-90 ans.

Avec la même hypothèse que pour la question 1, pourquoi ne peut-on pas simplement réaliser cette estimation sur l'ensemble de l'échantillon en utilisant directement les poids de sondage proposés ?

**Quelle(s) information(s) serait nécessaire pour réaliser cette estimation ?**

On fait donc l'hypothèse que la population reconstruite de chaque cohorte est représentative de sa population cible.

Mais l'échantillon total n'est pas représentatif de la population des 20-90 ans car certaines populations cibles se recoupent. Il nous manquerait la répartition en âge de la population totale par exemple pour essayer d'estimer la prévalence dans la population totale soit par standardisation directe ou indirecte de façon analogue à ce qui peut-être fait pour les incidences ?

Aussi, avec les cohortes C, D et E, on a à priori un échantillon représentatif de la population de 25 à 90 ans, comme si c'était stratifié sur 25 à 70 ans et 70 à 90 ans. On pourrait essayer de refaire une cohorte sur les 20 à 25 ans et reconstruire un sondage stratifié sur l'âge peut-être et utiliser l'estimateur d'Horvitz-Thomson.